<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 로또 영수증 스캔 및 당첨 확인 - 로또 6/45 Simulator</title>
    <meta name="description" content="Gemini AI를 활용한 스마트 로또 스캔 기능! 로또 영수증 사진만 찍으면 AI가 번호를 읽고 즉시 당첨 여부를 확인해 드립니다.">
    <meta name="keywords" content="로또당첨확인, 로또영수증스캔, AI로또인식, 로또번호확인, 로또QR스캔대체">
    <link rel="canonical" href="https://lotto-simulation.pages.dev/scan.html">
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body data-theme="dark">
    <header class="main-header">
        <div class="logo">🎱 Lotto 6/45 Simulator</div>
        <div class="settings-group">
            <nav>
                <a href="index.html">Main</a>
                <a href="about.html">About</a>
                <a href="stats.html">Stats</a>
                <a href="scan.html" class="active">AI Scan My Numbers<span style="font-size:0.6rem; vertical-align:top;">(Beta)</span></a>
            </nav>
        </div>
    </header>

    <div class="container" style="max-width: 800px; padding-top: 100px;">
        <h1 class="title">내 로또 번호 당첨 확인(AI)</h1>
        <p class="subtitle">인공지능이 영수증을 분석하여 번호를 정확하게 읽어드립니다.</p>

        <div style="margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; border: 1px solid #333; text-align: left;">
            <div style="margin-bottom: 10px;">
                <label style="font-size: 0.9rem; color: var(--primary-cyan); font-weight: bold;">🔑 Gemini API Key 입력:</label>
                <input type="password" id="apiKeyInput" placeholder="API 키를 입력하세요" 
                       style="background: #000; color: #fff; border: 1px solid var(--primary-pink); padding: 8px 12px; border-radius: 5px; width: 100%; max-width: 350px; margin-top: 5px;">
            </div>
            
            <div style="font-size: 0.8rem; color: #bbb; line-height: 1.6;">
                <p style="color: var(--primary-yellow); font-weight: bold; margin-bottom: 5px;">⚠️ 사용 시 주의사항 (과금 및 제한)</p>
                <ul style="padding-left: 20px; margin-bottom: 10px;">
                    <li>개인 API 키 사용 시 구글 정책에 따라 <strong>사용량 제한(Limit)</strong>에 걸릴 수 있습니다.</li>
                    <li>무료 티어를 초과하거나 설정에 따라 <strong>과금이 발생할 수 있으니</strong> 무분별한 반복 테스트는 지양해 주세요.</li>
                    <li>실시간 사용량은 <a href="https://aistudio.google.com/app/usage" target="_blank" style="color: var(--primary-cyan); text-decoration: underline;">Google AI Studio 사용량 관리</a> 페이지에서 확인하실 수 있습니다.</li>
                </ul>
                <p>💡 <strong>꿀팁:</strong> 스마트폰 카메라의 문서 스캔 기능을 이용해 실제 로또 용지를 그림자 없이 깨끗하게 촬영하시면 인식률이 훨씬 높아집니다.</p>
            </div>
        </div>

        <section class="info-section" style="border: 2px dashed var(--primary-cyan); background: rgba(0,243,255,0.05); padding: 40px; text-align: center; border-radius: 20px;">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <label for="imageInput" class="gold-button" style="width: 180px; height: 50px; border-radius: 25px; line-height: 50px; font-size: 0.9rem; cursor: pointer;">
                    📸 사진 선택/촬영
                </label>
                <button id="aiScanBtn" class="hp-btn" style="width: 180px; height: 50px; border-radius: 25px; border: none; font-size: 0.9rem; background: linear-gradient(135deg, #ff00aa, #00f3ff);">
                    🤖 AI 스마트 스캔
                </button>
            </div>
        </section>

        <div id="previewContainer" style="display: none; margin-top: 30px; text-align: center;">
            <img id="selectedImage" style="max-width: 100%; border-radius: 10px; border: 1px solid var(--primary-pink); max-height: 400px; object-fit: contain;">
            <div id="ocrStatus" style="margin-top: 20px; color: var(--primary-yellow); font-weight: bold;"></div>
        </div>

        <div id="scanResult" class="info-section" style="display: none; margin-top: 40px; text-align: left;">
            <h2 style="color: var(--primary-cyan); border-bottom: 1px solid var(--primary-cyan); padding-bottom: 10px;">🔍 인식 결과 확인</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem;">인식된 내용이 틀렸다면 직접 수정하신 후 [당첨 확인]을 눌러주세요.</p>
            <div style="margin-bottom: 15px;">
                <label style="color: var(--primary-yellow);">회차 정보:</label>
                <input type="number" id="scannedDrawNo" style="background: #111; color: #fff; border: 1px solid #444; padding: 5px 10px; width: 80px; margin-left: 10px;"> 회
            </div>
            <div id="linesContainer"></div>
            <button id="verifyButton" class="hp-btn" style="width: 100%; margin-top: 20px; border: none; font-size: 1.1rem;">🏆 당첨 확인하기</button>
        </div>

        <div id="winStatus" class="info-section" style="display: none; margin-top: 30px; border-color: var(--ball-green); background: rgba(10, 255, 10, 0.05);">
            <h2 style="color: var(--ball-green); text-align: center;">🎉 결과 리포트</h2>
            <div id="winDetail" style="margin-top: 20px; line-height: 2;"></div>
        </div>

        <div style="margin-top: 50px; padding: 20px; background: rgba(255, 0, 0, 0.05); border: 1px solid rgba(255, 0, 0, 0.1); border-radius: 10px; font-size: 0.8rem; line-height: 1.6; color: #888;">
            <p style="color: #aaa; font-weight: bold; margin-bottom: 5px;">⚠️ 이용 주의사항 및 보안 안내</p>
            <ul style="padding-left: 15px;">
                <li><strong>인식 오차 안내:</strong> AI 분석 결과는 100% 완벽하지 않을 수 있습니다. <strong>당첨 결과는 반드시 본인이 직접 재확인</strong>해야 하며, 서비스 제공자는 오인식으로 인한 결과에 책임을 지지 않습니다.</li>
                <li><strong>API 키 보안:</strong> 입력하신 키는 브라우저의 <strong>로컬 저장소(LocalStorage)에 저장</strong>되어 편리하게 재사용할 수 있습니다. 이 데이터는 제작자의 서버나 Cloudflare를 거치지 않고 Google API 서버로 직접 전송(HTTPS 암호화 통신)됩니다.</li>
                <li><strong>권장 환경:</strong> 타인이 접근할 수 있는 <strong>공용 PC나 공용 기기에서의 사용을 지양</strong>해 주세요. 브라우저 저장소에 기록된 키를 타인이 복사해 갈 위험이 있습니다.</li>
                <li><strong>개인정보 보호:</strong> 업로드하신 이미지는 AI 분석 후 브라우저 메모리에서 즉시 삭제되며, 어떠한 서버에도 저장되지 않습니다.</li>
            </ul>
        </div>
    </div>

    <footer class="main-footer"><p>&copy; 2026 Lotto Simulator. All rights reserved.</p></footer>
    <script src="script.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const imageInput = document.getElementById('imageInput');
        const aiScanBtn = document.getElementById('aiScanBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const selectedImage = document.getElementById('selectedImage');
        const previewContainer = document.getElementById('previewContainer');
        const ocrStatus = document.getElementById('ocrStatus');
        const scanResult = document.getElementById('scanResult');
        const linesContainer = document.getElementById('linesContainer');
        const scannedDrawNo = document.getElementById('scannedDrawNo');
        const verifyButton = document.getElementById('verifyButton');
        const winStatus = document.getElementById('winStatus');
        const winDetail = document.getElementById('winDetail');
        let lottoAllData = null, selectedFile = null;

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
        apiKeyInput.addEventListener('change', (e) => localStorage.setItem('gemini_api_key', e.target.value));

        async function loadLottoData() {
            try {
                const res = await fetch('data_all.json');
                lottoAllData = await res.json();
            } catch (e) { console.error("데이터 로딩 실패", e); }
        }
        loadLottoData();

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                selectedImage.src = event.target.result;
                previewContainer.style.display = 'block';
                ocrStatus.innerText = "📸 이미지가 선택되었습니다. [🤖 AI 스마트 스캔] 버튼을 눌러주세요.";
                ocrStatus.style.color = "var(--primary-cyan)";
                scanResult.style.display = 'none'; winStatus.style.display = 'none';
            };
            reader.readAsDataURL(file);
        });

        aiScanBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) return alert("Gemini API Key를 입력해주세요!");
            if (!selectedFile) return alert("먼저 로또 사진을 선택해주세요!");
            ocrStatus.innerText = "🤖 AI가 영수증 분석 중... (수 초 소요)"; ocrStatus.style.color = "var(--primary-yellow)";
            const modelNames = ["gemini-2.5-flash-lite", "gemini-2.5-flash", "gemini-3-flash"];
            let success = false;
            for (const modelName of modelNames) {
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: modelName });
                    const base64Data = await fileToGenerativePart(selectedFile);
                    const prompt = `이 로또 6/45 영수증 이미지에서 회차(draw_no)와 각 라인(A, B, C, D, E)의 번호 6개를 추출해서 JSON으로만 응답해줘. 결과 형식: {"draw_no": 1205, "lines": {"A": [1, 2, 3, 4, 5, 6]}}. 텍스트 설명 금지.`;
                    const result = await model.generateContent([prompt, base64Data]);
                    const text = (await result.response).text();
                    const data = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
                    populateFields(data);
                    ocrStatus.innerText = "✅ AI 분석 완료!"; ocrStatus.style.color = "var(--ball-green)";
                    success = true; break;
                } catch (err) {
                    if (err.message.includes("429")) { await wait(3500); continue; }
                    ocrStatus.innerText = "❌ 분석 실패: " + err.message; break;
                }
            }
        });

        async function fileToGenerativePart(file) {
            const base64 = await new Promise(r => { const f = new FileReader(); f.onloadend = () => r(f.result.split(',')[1]); f.readAsDataURL(file); });
            return { inlineData: { data: base64, mimeType: file.type } };
        }

        function populateFields(data) {
            scanResult.style.display = 'block'; linesContainer.innerHTML = '';
            scannedDrawNo.value = data.draw_no || "";
            ['A', 'B', 'C', 'D', 'E'].forEach(char => {
                const nums = data.lines[char];
                const div = document.createElement('div');
                div.style.cssText = "margin-bottom:10px; display:flex; align-items:center; gap:10px;";
                div.innerHTML = `<strong style="width:25px; color:var(--primary-pink);">${char}</strong><input type="text" class="line-input" data-line="${char}" value="${nums ? nums.join(' ') : ''}" placeholder="인식 실패" style="flex:1; background:#1a1a2e; color:#fff; border:1px solid #333; padding:10px; border-radius:8px;">`;
                linesContainer.appendChild(div);
            });
        }

        verifyButton.addEventListener('click', () => {
            const targetDrawNo = parseInt(scannedDrawNo.value);
            const winDraw = lottoAllData.history.find(h => h.draw_no === targetDrawNo);
            if (!winDraw) return alert(`${targetDrawNo}회차 정보를 찾을 수 없습니다.`);
            const winNums = [winDraw.num1, winDraw.num2, winDraw.num3, winDraw.num4, winDraw.num5, winDraw.num6], bonus = winDraw.bonus;
            winStatus.style.display = 'block';
            winDetail.innerHTML = `<h3 style="text-align:center; color:var(--primary-cyan);">[${targetDrawNo}회 당첨번호: ${winNums.join(', ')} + ${bonus}]</h3>`;
            document.querySelectorAll('.line-input').forEach(input => {
                const val = input.value.trim(); if (!val) return;
                const userNums = val.split(/\s+/).map(n => parseInt(n));
                const matches = userNums.filter(n => winNums.includes(n));
                const hasBonus = userNums.includes(bonus);
                let rank = "낙첨", color = "#888";
                if (matches.length === 6) { rank = "1등! 🏆"; color = "var(--primary-yellow)"; }
                else if (matches.length === 5 && hasBonus) { rank = "2등! 🥈"; color = "var(--primary-cyan)"; }
                else if (matches.length === 5) { rank = "3등! 🥉"; color = "var(--primary-pink)"; }
                else if (matches.length === 4) { rank = "4등 (5만원)"; color = "var(--ball-green)"; }
                else if (matches.length === 3) { rank = "5등 (5천원)"; color = "var(--ball-green)"; }
                const ballHtml = userNums.map(n => {
                    const isWin = winNums.includes(n), isB = (n === bonus);
                    const bc = isWin ? 'var(--primary-yellow)' : (isB ? 'var(--primary-cyan)' : '#333');
                    return `<span style="display:inline-block; width:25px; height:25px; line-height:25px; border-radius:50%; background:${bc}; color:${isWin||isB?'#000':'#888'}; font-size:12px; font-weight:bold; margin-right:3px; text-align:center;">${n}</span>`;
                }).join('');
                winDetail.innerHTML += `<div style="margin-bottom:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;"><span style="font-weight:bold; margin-right:10px;">${input.getAttribute('data-line')}</span>${ballHtml}<span style="margin-left: 15px; font-weight:bold; color:${color};">${rank}</span></div>`;
            });
        });
    </script>
</body>
</html>