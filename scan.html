<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œë˜ ìŠ¤ìº” - ë¡œë˜ ì‹œë®¬ë ˆì´í„°</title>
    <link rel="stylesheet" href="style.css">
    <!-- Tesseract.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- Google AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body>
    <header class="main-header">
        <div class="logo">ğŸ± Lotto Sim</div>
        <div class="settings-group">
            <nav>
                <a href="index.html">í™ˆ</a>
                <a href="about.html">ì†Œê°œ</a>
                <a href="stats.html">í†µê³„</a>
                <a href="scan.html" class="active">ë²ˆí˜¸ë‹¹ì²¨í™•ì¸<span style="font-size:0.6rem; vertical-align:top;">(Beta)</span></a>
            </nav>
            <button id="langToggle" class="toggle-btn">ENG</button>
            <button id="themeToggle" class="toggle-btn">ğŸŒ</button>
        </div>
    </header>

    <div class="container" style="max-width: 800px; padding-top: 100px;">
        <h1 class="title">ì˜ìˆ˜ì¦ AI ìŠ¤ìº”</h1>
        <p class="subtitle">ì¸ê³µì§€ëŠ¥ì´ ì˜ìˆ˜ì¦ì„ ë¶„ì„í•˜ì—¬ ë²ˆí˜¸ë¥¼ 100% ì •í™•í•˜ê²Œ ì½ì–´ë“œë¦½ë‹ˆë‹¤.</p>

        <!-- API Key Config (Zero Cost Strategy) -->
        <div style="margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid #333;">
            <label style="font-size: 0.8rem; color: var(--primary-cyan);">ğŸ”‘ Gemini API Key (ë¬´ë£Œ):</label>
            <input type="password" id="apiKeyInput" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                   style="background: #000; color: #fff; border: 1px solid var(--primary-pink); padding: 5px 10px; border-radius: 5px; width: 250px; margin-left: 10px;">
            <p style="font-size: 0.7rem; color: #888; margin-top: 5px;">* í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary-yellow);">ë¬´ë£Œ í‚¤ ë°œê¸‰ë°›ê¸°</a></p>
        </div>

        <section class="info-section" style="border: 2px dashed var(--primary-cyan); background: rgba(0,243,255,0.05); padding: 40px; text-align: center; border-radius: 20px;">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <label for="imageInput" class="gold-button" style="width: 180px; height: 50px; border-radius: 25px; line-height: 50px; font-size: 0.9rem; cursor: pointer;">
                    ğŸ“¸ ì‚¬ì§„ ì„ íƒ/ì´¬ì˜
                </label>
                <button id="aiScanBtn" class="hp-btn" style="width: 180px; height: 50px; border-radius: 25px; border: none; font-size: 0.9rem; background: linear-gradient(135deg, #ff00aa, #00f3ff);">
                    ğŸ¤– AI ìŠ¤ë§ˆíŠ¸ ìŠ¤ìº”
                </button>
            </div>
            <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-dim);">* AI ìŠ¤ìº”ì€ íë¦¿í•œ ì‚¬ì§„ë„ ì •í™•í•˜ê²Œ ì½ì–´ëƒ…ë‹ˆë‹¤.</p>
        </section>

        <!-- Preview and Progress -->
        <div id="previewContainer" style="display: none; margin-top: 30px; text-align: center;">
            <img id="selectedImage" style="max-width: 100%; border-radius: 10px; border: 1px solid var(--primary-pink); max-height: 400px; object-fit: contain;">
            <div id="ocrStatus" style="margin-top: 20px; color: var(--primary-yellow); font-weight: bold;"></div>
        </div>

        <!-- Disclaimer & Security Warning -->
        <div style="margin-top: 30px; padding: 20px; background: rgba(255, 0, 0, 0.05); border: 1px solid rgba(255, 0, 0, 0.2); border-radius: 10px; font-size: 0.85rem; line-height: 1.6; color: #ccc;">
            <p style="color: var(--primary-pink); font-weight: bold; margin-bottom: 10px;">âš ï¸ ì´ìš© ì£¼ì˜ì‚¬í•­ ë° ë²•ì  ê³ ì§€</p>
            <ul style="padding-left: 20px; list-style-type: decimal;">
                <li><strong>API Key ë³´ì•ˆ:</strong> ì…ë ¥í•˜ì‹  API KeyëŠ” ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œ(LocalStorage)ì—ë§Œ ì €ì¥ë˜ë©°, ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ê³µìš© PCì—ì„œëŠ” ì‚¬ìš© í›„ í‚¤ë¥¼ ë°˜ë“œì‹œ ì‚­ì œí•´ ì£¼ì„¸ìš”.</li>
                <li><strong>ì¸ì‹ ì˜¤ì°¨ ê°€ëŠ¥ì„±:</strong> ë³¸ AI ìŠ¤ìº” ê¸°ëŠ¥ì€ ì¸ê³µì§€ëŠ¥ ëª¨ë¸(Gemini)ì„ ì´ìš©í•œ ë¶„ì„ ê²°ê³¼ë¡œ, ì‚¬ì§„ì˜ ê°ë„, ë°ê¸°, í™”ì§ˆì— ë”°ë¼ <strong>ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></li>
                <li><strong>ë²•ì  ì±…ì„ ë©´ì œ:</strong> ë³¸ ì„œë¹„ìŠ¤ì˜ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì¼ ë¿ì´ë©°, <strong>ì‹¤ì œ ë‹¹ì²¨ ì—¬ë¶€ì— ëŒ€í•œ ë²•ì  íš¨ë ¥ì´ë‚˜ ë³´ìƒ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong></li>
                <li><strong>ìµœì¢… í™•ì¸ ì˜ë¬´:</strong> ì‹¤ì œ ë‹¹ì²¨ ì—¬ë¶€ëŠ” ë°˜ë“œì‹œ <a href="https://www.dhlottery.co.kr/" target="_blank" style="color: var(--primary-yellow);">ë™í–‰ë³µê¶Œ ê³µì‹ í™ˆí˜ì´ì§€</a> ë˜ëŠ” ì˜¤í”„ë¼ì¸ íŒë§¤ì ì—ì„œ ì§ì ‘ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
            </ul>
        </div>

        <!-- Scan Result (Editable) -->
        <div id="scanResult" class="info-section" style="display: none; margin-top: 40px; text-align: left;">
            <h2 style="color: var(--primary-cyan); border-bottom: 1px solid var(--primary-cyan); padding-bottom: 10px;">ğŸ” ì¸ì‹ ê²°ê³¼ í™•ì¸</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem;">ì¸ì‹ëœ ë‚´ìš©ì´ í‹€ë ¸ë‹¤ë©´ ì§ì ‘ ìˆ˜ì •í•˜ì‹  í›„ [ë‹¹ì²¨ í™•ì¸]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            
            <div style="margin-bottom: 15px;">
                <label style="color: var(--primary-yellow);">íšŒì°¨ ì •ë³´:</label>
                <input type="number" id="scannedDrawNo" style="background: #111; color: #fff; border: 1px solid #444; padding: 5px 10px; width: 80px; margin-left: 10px;"> íšŒ
            </div>

            <div id="linesContainer">
                <!-- A, B, C, D, E lines will be generated here -->
            </div>

            <button id="verifyButton" class="hp-btn" style="width: 100%; margin-top: 20px; border: none; font-size: 1.1rem;">ğŸ† ë‹¹ì²¨ í™•ì¸í•˜ê¸°</button>
        </div>

        <!-- Final Win Status -->
        <div id="winStatus" class="info-section" style="display: none; margin-top: 30px; border-color: var(--ball-green); background: rgba(10, 255, 10, 0.05);">
            <h2 style="color: var(--ball-green); text-align: center;">ğŸ‰ ê²°ê³¼ ë¦¬í¬íŠ¸</h2>
            <div id="winDetail" style="margin-top: 20px; line-height: 2;">
                <!-- Detailed win results -->
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <p>&copy; 2026 Lotto Simulator. All rights reserved.</p>
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const imageInput = document.getElementById('imageInput');
        const aiScanBtn = document.getElementById('aiScanBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const selectedImage = document.getElementById('selectedImage');
        const previewContainer = document.getElementById('previewContainer');
        const ocrStatus = document.getElementById('ocrStatus');
        const scanResult = document.getElementById('scanResult');
        const linesContainer = document.getElementById('linesContainer');
        const scannedDrawNo = document.getElementById('scannedDrawNo');
        const verifyButton = document.getElementById('verifyButton');
        const winStatus = document.getElementById('winStatus');
        const winDetail = document.getElementById('winDetail');

        let lottoAllData = null;
        let selectedFile = null;

        // Initialize: Load API Key from LocalStorage
        apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
        apiKeyInput.addEventListener('change', (e) => localStorage.setItem('gemini_api_key', e.target.value));

        // Load data with error handling for local file access
        async function loadLottoData() {
            try {
                const res = await fetch('data_all.json');
                if (!res.ok) throw new Error('Network response was not ok');
                lottoAllData = await res.json();
                console.log("Data All loaded:", lottoAllData.history.length);
            } catch (e) {
                console.error("Data load failed:", e);
                if (window.location.protocol === 'file:') {
                    alert("âš ï¸ ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ë¡œì»¬ì—ì„œëŠ” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²°ë°©ë²•:\n1. í„°ë¯¸ë„ì—ì„œ 'python -m http.server' ì‹¤í–‰ í›„ ì ‘ì†\n2. ë˜ëŠ” ë°°í¬ëœ ì‚¬ì´íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸");
                }
            }
        }
        loadLottoData();

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file; 
            
            const reader = new FileReader();
            reader.onload = (event) => {
                selectedImage.src = event.target.result;
                previewContainer.style.display = 'block';
                ocrStatus.innerText = "ğŸ“¸ ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. [ğŸ¤– AI ìŠ¤ë§ˆíŠ¸ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                ocrStatus.style.color = "var(--primary-cyan)";
                scanResult.style.display = 'none';
                winStatus.style.display = 'none';
            };
            reader.readAsDataURL(file);
        });

        // Helper: Wait function (MUST be defined before use)
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        aiScanBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) return alert("Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (!selectedFile) return alert("ë¨¼ì € ë¡œë˜ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");

            ocrStatus.innerText = "ğŸ¤– AIê°€ ì˜ìˆ˜ì¦ ë¶„ì„ ì¤‘... (ìˆ˜ ì´ˆ ì†Œìš”)";
            ocrStatus.style.color = "var(--primary-yellow)";
            scanResult.style.display = 'none';
            
            // Priority: gemini-1.5-flash is the most stable and available model for free tier
            const modelNames = ["gemini-1.5-flash", "gemini-1.5-flash-8b", "gemini-2.0-flash"];
            let success = false;

            for (const modelName of modelNames) {
                try {
                    console.log(`ğŸš€ Attempting AI Scan with model: ${modelName}...`);
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: modelName });

                    const base64Data = await fileToGenerativePart(selectedFile);
                    const prompt = `ì´ ë¡œë˜ 6/45 ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ì—ì„œ íšŒì°¨(draw_no)ì™€ ê° ë¼ì¸(A, B, C, D, E)ì˜ ë²ˆí˜¸ 6ê°œë¥¼ ì¶”ì¶œí•´ì„œ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•´ì¤˜. 
                    ê²°ê³¼ í˜•ì‹: {"draw_no": 1205, "lines": {"A": [1, 2, 3, 4, 5, 6], "B": [10, 11, 12, 13, 14, 15]}} 
                    í…ìŠ¤íŠ¸ ì„¤ëª…ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆ.`;

                    const result = await model.generateContent([prompt, base64Data]);
                    const response = await result.response;
                    const text = response.text();
                    
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("JSON ì¶”ì¶œ ì‹¤íŒ¨");
                    
                    const data = JSON.parse(jsonMatch[0]);
                    populateFields(data);
                    
                    ocrStatus.innerText = `âœ… AI ë¶„ì„ ì™„ë£Œ! (ì‚¬ìš©í•œ ëª¨ë¸: ${modelName})`;
                    ocrStatus.style.color = "var(--ball-green)";
                    success = true;
                    break; 
                } catch (err) {
                    console.warn(`âš ï¸ Model ${modelName} failed:`, err.message);
                    
                    // Handle Quota Limit
                    if (err.message.includes("429") || err.message.includes("quota")) {
                        if (modelName !== modelNames[modelNames.length - 1]) {
                            ocrStatus.innerText = `â³ í• ë‹¹ëŸ‰ ì´ˆê³¼ë¡œ ì¸í•´ ë‹¤ë¥¸ ëª¨ë¸ë¡œ ì „í™˜ ì¤‘...`;
                            await wait(3000); 
                            continue;
                        }
                    }

                    // Handle Auth
                    if (err.message.includes("401") || err.message.includes("API_KEY_INVALID")) {
                        ocrStatus.innerText = "âŒ ë¶„ì„ ì‹¤íŒ¨: API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                        ocrStatus.style.color = "var(--primary-pink)";
                        return;
                    }
                }
            }

            if (!success) {
                ocrStatus.innerText = "âŒ ëª¨ë“  AI ëª¨ë¸ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¬´ë£Œ í• ë‹¹ëŸ‰ì´ ì†Œì§„ë˜ì—ˆê±°ë‚˜, ë‹¤ë¥¸ ë¡œë˜ ì‚¬ì§„ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”)";
                ocrStatus.style.color = "var(--primary-pink)";
            }
        });

        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        function populateFields(data) {
            scanResult.style.display = 'block';
            linesContainer.innerHTML = '';
            scannedDrawNo.value = data.draw_no || "";

            const slots = ['A', 'B', 'C', 'D', 'E'];
            slots.forEach(char => {
                const nums = data.lines[char];
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                div.innerHTML = `
                    <strong style="width: 25px; color: var(--primary-pink);">${char}</strong>
                    <input type="text" class="line-input" data-line="${char}" value="${nums ? nums.join(' ') : ''}" 
                           placeholder="ì¸ì‹ ì‹¤íŒ¨ (ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)" 
                           style="flex: 1; background: #1a1a2e; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 8px; font-family: monospace;">
                `;
                linesContainer.appendChild(div);
            });
        }

        // Keep Verification logic
        verifyButton.addEventListener('click', () => {
            if (!lottoAllData) return alert("ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
            const targetDrawNo = parseInt(scannedDrawNo.value);
            const winDraw = lottoAllData.history.find(h => h.draw_no === targetDrawNo);
            if (!winDraw) return alert(`${targetDrawNo}íšŒì°¨ ë‹¹ì²¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);

            const winNums = [winDraw.num1, winDraw.num2, winDraw.num3, winDraw.num4, winDraw.num5, winDraw.num6];
            const bonus = winDraw.bonus;

            winStatus.style.display = 'block';
            winDetail.innerHTML = `<h3 style="text-align:center; color: var(--primary-cyan); margin-bottom:15px;">[${targetDrawNo}íšŒ ë‹¹ì²¨ë²ˆí˜¸: ${winNums.join(', ')} + ${bonus}]</h3>`;

            document.querySelectorAll('.line-input').forEach(input => {
                const char = input.getAttribute('data-line');
                const val = input.value.trim();
                if (!val) return;
                const userNums = val.split(/\s+/).map(n => parseInt(n));
                const matches = userNums.filter(n => winNums.includes(n));
                const hasBonus = userNums.includes(bonus);
                let rank = "ë‚™ì²¨", rankColor = "#888";
                if (matches.length === 6) { rank = "1ë“± ë‹¹ì²¨! ğŸ†"; rankColor = "var(--primary-yellow)"; }
                else if (matches.length === 5 && hasBonus) { rank = "2ë“± ë‹¹ì²¨! ğŸ¥ˆ"; rankColor = "var(--primary-cyan)"; }
                else if (matches.length === 5) { rank = "3ë“± ë‹¹ì²¨! ğŸ¥‰"; rankColor = "var(--primary-pink)"; }
                else if (matches.length === 4) { rank = "4ë“± (5ë§Œì›) ğŸ’°"; rankColor = "var(--ball-green)"; }
                else if (matches.length === 3) { rank = "5ë“± (5ì²œì›) ğŸ€"; rankColor = "var(--ball-green)"; }

                const ballHtml = userNums.map(n => {
                    const isWin = winNums.includes(n), isBonus = (n === bonus);
                    const color = isWin ? 'var(--primary-yellow)' : (isBonus ? 'var(--primary-cyan)' : '#333');
                    return `<span style="display:inline-block; width:25px; height:25px; line-height:25px; border-radius:50%; background:${color}; color:${isWin || isBonus ? '#000' : '#888'}; font-size:12px; font-weight:bold; margin-right:3px; text-align:center; border:1px solid #555;">${n}</span>`;
                }).join('');

                winDetail.innerHTML += `<div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;"><span style="font-weight:bold; margin-right:10px;">${char}</span>${ballHtml}<span style="margin-left: 15px; font-weight:bold; color: ${rankColor};">${rank}</span></div>`;
            });
            winStatus.scrollIntoView({ behavior: 'smooth' });
        });
    </script>
</body>
</html>
